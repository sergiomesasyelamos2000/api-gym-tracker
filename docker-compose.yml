version: '3.8'

services:
  api:
    build:
      context: .
      target: development
    ports:
      - '3000:3000'
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
      - ./credentials:/usr/src/app/credentials
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - GOOGLE_APPLICATION_CREDENTIALS=/usr/src/app/credentials/google-credentials.json
    command: >
      sh -c "
        echo '‚è≥ Waiting for PostgreSQL to be ready...' &&
        until nc -z postgres 5432; do
          echo '‚è≥ PostgreSQL is unavailable - sleeping'
          sleep 2
        done &&
        echo '‚úÖ PostgreSQL is ready!' &&
        echo 'üì¶ Installing dependencies...' &&
        npm install &&
        echo 'üîÑ Running migrations...' &&
        npm run migration:run &&
        echo '‚úÖ Migrations completed!' &&
        echo 'üöÄ Starting API server...' &&
        npm run start:dev
      "

  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: ${DATABASE_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-postgres}
      POSTGRES_DB: ${DATABASE_NAME:-gym_db}
    command:
      - 'postgres'
      - '-c'
      - 'log_min_duration_statement=100'
      - '-c'
      - 'log_statement=none'
      - '-c'
      - 'log_duration=off'
      - '-c'
      - 'max_connections=200'
      - '-c'
      - 'shared_buffers=256MB'
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

  pgadmin:
    image: dpage/pgadmin4
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - '5050:80'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres

  k6:
    image: grafana/k6:latest
    networks:
      - default
    volumes:
      - ./tests:/scripts
    environment:
      - BASE_URL=http://api:3000
      - K6_OUT=influxdb=http://influxdb:8086/k6
    depends_on:
      - api
      - influxdb
    command: run /scripts/stress-test.js
    profiles:
      - testing

  influxdb:
    image: influxdb:1.8-alpine
    networks:
      - default
    ports:
      - '8086:8086'
    environment:
      - INFLUXDB_DB=k6
      - INFLUXDB_HTTP_MAX_BODY_SIZE=0
    volumes:
      - influxdb_data:/var/lib/influxdb
    profiles:
      - testing

  grafana:
    image: grafana/grafana:latest
    networks:
      - default
    ports:
      - '3001:3000'
    environment:
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_BASIC_ENABLED=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - influxdb
    profiles:
      - testing

volumes:
  postgres_data:
  redis_data:
  pgadmin_data:
  influxdb_data:
  grafana_data:
