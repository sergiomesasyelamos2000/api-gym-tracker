#!/usr/bin/env node

/**
 * Migration Check Script
 *
 * This script checks if there are pending schema changes that need migrations.
 * It compares the current entity definitions with the database schema.
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const MIGRATIONS_DIR = path.join(__dirname, '..', 'src', 'migrations');

function log(message, type = 'info') {
  const colors = {
    info: '\x1b[36m', // Cyan
    success: '\x1b[32m', // Green
    warning: '\x1b[33m', // Yellow
    error: '\x1b[31m', // Red
  };
  const reset = '\x1b[0m';
  console.log(`${colors[type]}${message}${reset}`);
}

function getMigrationCount() {
  if (!fs.existsSync(MIGRATIONS_DIR)) {
    return 0;
  }
  return fs.readdirSync(MIGRATIONS_DIR).filter(f => f.endsWith('.ts')).length;
}

async function checkAndGenerateMigration() {
  log('ğŸ” Checking for schema changes...', 'info');

  const initialCount = getMigrationCount();

  try {
    // Try to generate a migration
    const timestamp = Date.now();
    const migrationName = `AutoGenerated${timestamp}`;
    log(`ğŸ“ Attempting to generate migration: ${migrationName}`, 'info');

    const output = execSync(
      `npm run migration:generate -- src/migrations/${migrationName}`,
      { encoding: 'utf8', stdio: 'pipe' },
    );

    const finalCount = getMigrationCount();

    if (finalCount > initialCount) {
      log('âœ… Migration generated successfully!', 'success');
      log(`ğŸ“„ New migration file created in ${MIGRATIONS_DIR}`, 'success');

      // Get the newest migration file
      const files = fs
        .readdirSync(MIGRATIONS_DIR)
        .filter(f => f.endsWith('.ts'))
        .map(f => ({
          name: f,
          time: fs.statSync(path.join(MIGRATIONS_DIR, f)).mtime.getTime(),
        }))
        .sort((a, b) => b.time - a.time);

      if (files.length > 0) {
        log(`ğŸ“‹ Migration file: ${files[0].name}`, 'info');
      }

      return true;
    } else {
      log('âœ… No schema changes detected - database is in sync!', 'success');
      return false;
    }
  } catch (error) {
    const errorMessage = error.message || error.toString();
    const errorOutput = error.stderr || error.stdout || errorMessage;

    // Check if the error is because there are no changes
    if (
      errorOutput.includes('No changes in database schema were found') ||
      errorOutput.includes('No changes')
    ) {
      log('âœ… No schema changes detected - database is in sync!', 'success');
      return false;
    }

    // Check if it's a connection error (expected in local environment)
    if (
      errorOutput.includes('ECONNREFUSED') ||
      errorOutput.includes('connect') ||
      errorOutput.includes('database')
    ) {
      log(
        'âš ï¸  Cannot connect to database - this is normal if DB is not running locally',
        'warning',
      );
      log(
        'â„¹ï¸  Migrations will be checked when Docker containers start',
        'info',
      );
      return false;
    }

    log('âŒ Error checking migrations:', 'error');
    log(errorOutput, 'error');
    throw error;
  }
}

// Run the check
checkAndGenerateMigration()
  .then(generated => {
    process.exit(generated ? 0 : 0); // Exit 0 in both cases (success)
  })
  .catch(error => {
    log('âŒ Migration check failed', 'error');
    process.exit(1);
  });
