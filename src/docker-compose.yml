version: '3.8'

services:
  api:
    build:
      context: .
      target: development
    ports:
      - '3000:3000'
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
    env_file:
      - .env
    depends_on:
      - postgres
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
    command: sh -c "npm run migration:run || true && npm run start:dev"

  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: ${DATABASE_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-postgres}
      POSTGRES_DB: ${DATABASE_NAME:-gym_db}
    command:
      - 'postgres'
      - '-c'
      - 'log_min_duration_statement=100'
      - '-c'
      - 'log_statement=none'
      - '-c'
      - 'log_duration=off'
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - '5050:80'
    volumes:
      - ./servers.json:/pgadmin4/servers.json
    depends_on:
      - postgres

  k6:
    image: grafana/k6:latest
    networks:
      - default
    volumes:
      - ./tests:/scripts
    environment:
      - BASE_URL=http://api:3000
      - K6_OUT=influxdb=http://influxdb:8086/k6
    depends_on:
      - api
      - influxdb
    command: run /scripts/smoke-test.js
    profiles:
      - testing

  influxdb:
    image: influxdb:1.8-alpine
    networks:
      - default
    ports:
      - '8086:8086'
    environment:
      - INFLUXDB_DB=k6
      - INFLUXDB_HTTP_MAX_BODY_SIZE=0
    volumes:
      - influxdb_data:/var/lib/influxdb
    profiles:
      - testing

  grafana:
    image: grafana/grafana:latest
    networks:
      - default
    ports:
      - '3001:3000'
    environment:
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_BASIC_ENABLED=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - influxdb
    profiles:
      - testing

volumes:
  postgres_data:
  influxdb_data:
  grafana_data:
